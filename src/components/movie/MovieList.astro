---
import type { CollectionEntry } from 'astro:content';
import type { Movie } from '../../utils/appwrite.ts';
import MoviePost from './MoviePost.astro';
import { TicketIcon } from '@heroicons/vue/24/outline';

interface MovieData {
  title: string;
  poster?: string;
  description?: string;
  cast?: string[];
  rating?: string;
  length?: string;
  genre?: string[];
  trailer?: string;
  showtimes?: { date: string; time: string; }[];
  reelAlternative?: boolean;
}

interface Props {
  movieEntries: Movie[];
}

const { movieEntries } = Astro.props as Props;

// Map to component format
const activeMovies = movieEntries.map((movie: Movie) => ({
  data: {
    title: movie.title,
    poster: movie.posterUrl,
    description: movie.description,
    cast: movie.cast,
    rating: movie.rating,
    length: movie.runtime?.toString(),
    genre: movie.genre,
    trailer: movie.trailerUrl,
    showtimes: movie.showTimes?.map((showtime: string, index: number, array: string[]) => {
      const date = new Date(showtime);
      const isLastShowtime = index === array.length - 1;
      const isMatinee = array.length === 3 && isLastShowtime;
      
      return {
        date: date.toLocaleDateString('en-US', { 
          month: 'short',
          day: 'numeric'
        }) + (isMatinee ? ' - Matinee' : ''),
        time: date.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit'
        })
      };
    }),
    reelAlternative: movie.isReelAlternative
  },
  slug: movie.id
}));

---

<!-- This is the event listings page -->
<div class="mx-auto grid grid-cols-1 gap-x-8 gap-y-2 xl:gap-y-20 xl:grid-cols-3">
  <div class="mx-auto flex flex-col lg:mx-0 lg:max-w-none w-full col-span-2 lg:col-span-1">
    <h2 class="text-2xl font-bold tracking-tight text-slate-900 sm:text-4xl">Showtimes</h2>
    <p class="mt-6 text-lg leading-2 text-slate-600">Evening shows: 7:30pm</p>
    <p>Matinee: 2:00pm</p>

    <p class="mt-6 text-slate-400">We no longer have evening shows on Sundays</p>
    <div class="shadow-sm overflow-hidden my-8 rounded-lg max-w-4xl">
      <table class="border-collapse w-full text-sm table-auto">
        <thead class="bg-slate-50">
          <tr>
            <th class="border-b font-semibold p-4 text-slate-400 text-left">Ticket Pricing</th>
            <th class="border-b font-semibold p-4 text-slate-400">
              <TicketIcon class="not-sr-only h-5 w-5" aria-hidden="true"/>
            </th>
          </tr>
        </thead>
        <tbody class="bg-white">
          <tr>
            <td class="border-b border-slate-100 p-4 text-slate-500">Adults</td>
            <td class="border-b border-slate-100 p-4 text-slate-500">$10</td>
          </tr>
          <tr>
            <td class="border-b border-slate-100 p-4 text-slate-500">Seniors</td>
            <td class="border-b border-slate-100 p-4 text-slate-500">$8</td>
          </tr>
          <tr>
            <td class="border-b border-slate-100 p-4 text-slate-500">Students</td>
            <td class="border-b border-slate-100 p-4 text-slate-500">$8</td>
          </tr>
          <tr>
            <td class="border-b border-slate-100 p-4 text-slate-500">Children 3-11</td>
            <td class="border-b border-slate-100 p-4 text-slate-500">$5</td>
          </tr>
          <tr>
            <td class="border-b border-slate-100 p-4 text-slate-500">Family</td>
            <td class="border-b border-slate-100 p-4 text-slate-500">$25</td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="text-gray-400">For showtimes call <a href="tel:1780-673-1325" itemprop="telephone" class="whitespace-nowrap text-sm text-purple-600 hover:underline">780-673-1325</a></p>
  </div>

  <div class="col-span-2">
    <ul role="list" class="space-y-12 lg:space-y-12">
      {activeMovies.map((entry) => (
        <li>
          <MoviePost movie={{
            data: {
              title: entry.data.title,
              poster: entry.data.poster,
              description: entry.data.description,
              cast: entry.data.cast,
              rating: entry.data.rating,
              length: entry.data.length,
              genre: entry.data.genre,
              trailer: entry.data.trailer,
              showtimes: entry.data.showtimes,
              reelAlternative: entry.data.reelAlternative
            },
            slug: entry.slug
          }} />
        </li>
      ))}
    </ul>
  </div>
</div>

<style>
  .badge {
    font-size: 0.75rem;
  }
  .rating-outline {
    border: 1px solid;
    padding: 0.25rem 0.5rem;
  }
</style>