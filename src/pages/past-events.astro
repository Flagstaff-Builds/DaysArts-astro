---
import Layout from "../layouts/Layout.astro";
import Main from "@components/html-structure/Main.astro";
import HeroSecondary from "@components/hero-secondary.astro";
import { FireIcon } from "@heroicons/vue/24/outline";

interface EventFrontmatter {
  title: string;
  date?: string;
  description?: string;
}

type EventFile = {
  frontmatter: EventFrontmatter;
  file: string;
  url: string;
};

// Load all event files using import.meta.glob
const eventFiles = await Promise.all(
  Object.entries(await import.meta.glob<{ frontmatter: EventFrontmatter }>('../content/event/_old/*.{md,mdx}'))
    .map(async ([file, importFunc]) => {
      const event = await importFunc();
      return {
        ...event,
        file,
        url: file.replace('../content/event/_old', '/event').replace(/\.(md|mdx)$/, '')
      } as EventFile;
    })
);

// Sort events by date (newest first)
const sortedEvents = eventFiles.sort((a, b) => 
  (b.frontmatter.date || '').localeCompare(a.frontmatter.date || '')
);

// Group events by season (e.g., "2023 - 2024")
function getSeasonFromDate(dateStr: string | undefined): string {
  if (!dateStr) return "Unknown Season";
  
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = date.getMonth(); // 0-11
  
  // If month is after July (index 6), it's part of the year-year+1 season
  // Otherwise it's part of the year-1-year season
  if (month > 6) {
    return `${year} - ${year + 1}`;
  } else {
    return `${year - 1} - ${year}`;
  }
}

// Get current date to determine the current season
const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth();
const currentSeason = currentMonth > 6 
  ? `${currentYear} - ${currentYear + 1}` 
  : `${currentYear - 1} - ${currentYear}`;

// Group events by season
const eventsBySeasons: Record<string, EventFile[]> = {};

sortedEvents.forEach(event => {
  const season = getSeasonFromDate(event.frontmatter.date);
  if (!eventsBySeasons[season]) {
    eventsBySeasons[season] = [];
  }
  eventsBySeasons[season].push(event);
});

// Get seasons in descending order (newest first)
const seasons = Object.keys(eventsBySeasons).sort().reverse();

// Manually defined past seasons (for historical data)
const manuallyDefinedSeasons = {
  "2022 - 2023": "Luke McMaster, Ken Lavigne, Shelly Jones & A Touch of Cole, Garrett Gregory & Karac Hendriks, Ann Vriend, Ryan McMahon",
  "2022": "Amy Bishop, Prisoner of Tehran, Sarah Hagan, Martin Kerr, Diyet and the Love Soldiers",
  "2019 - 2020": "Terry Barber, Across The Pond | The British Invasion, Tim Tamishiro, Lizzy Hoyt – New Lady on the Prairie, Accidental Humour Co. The Flying Detective, Diyet and The Love Soldiers (Cancelled)",
  "2018 - 2019": "Johnny Summers Little Big Band, Ghostboy, Matthew Byrne, Gunning & Cormier, Samantha Martin and Delta Sugar, Miss Caledonia",
  "2017 - 2018": "Port Cities, Best Little Newfoundland Christmas Pageant... Ever, Blake Reid and The Black Dirt Orchestra, Christopher Hall and The Comic Quartet, Krystal Dos Santos and The Black Mambas",
  "2016 - 2017": "The Derina Harvey Band, Quartette, Scott Cook, Jim Byrnes, Lisa Brokop, Everything Fitz",
  "2015 - 2016": "Christine Tassan, John Wort Hannam, Steve Pineo's Elvis Show, 6 Guitars with Chase Padgett, The Carolines, David Myles",
  "2014 - 2015": "Connie Kaldor, Bridget Ryan's 'Here's to the Ladies Who Laugh', The Travelling Mabels, Jim Witter's 'Feelin Groovy', Tomas Kubinek – Certified Lunatic and Master of the Impossible, The Bills",
  "2013 - 2014": "Gordie Mackeeman & His Rhythm Boys, Like Father, Like Son? Sorry, Hotel California, Pear, When That I Was, University of Alberta Symphony Orchestra",
  "2012 - 2013": "Jake's Gift with The Darling Diva opening, Irish Rovers, Garth Prince, Lennie Gallant, Motus 'O' Dance – Circus Terrifico, Jesse Peters Trio",
  "2011 - 2012": "Letter from Wingfield Farm, Al Simmons, Hippodrome, April Verch, Woody Holler and His Orchestra, Valdy",
  "2010 - 2011": "Michelle Wright, Paul Rumbolt, The Shirleys, Jeff Straker, Pioneer Years, The Polyjesters",
  "2009 - 2010": "Brett Kissell, Rhyme Rustler, Celtara, Cadence, Jack Semple, The Arrogant Worms",
  "2008 - 2009": "Lorne Elliot, Babette's Feast (Augustana), Bottom Line Duo, John Wort Hannam, Ten Lost Years",
  "2007 - 2008": "Dust Poets, Brad Johner, Patricia O'Callaghan, Connie Kaldor, Visions Country Gospel",
  "2006 - 2007": "Glamour Puss, Rodeo Riders, Tillers Folley, Carlene Friesen, The Classics"
};

// Winter Matinee Concert Series by season
const winterMatineeSeries = {
  "2019 - 2020": "The Silver Screen Scoundrels, Jazz Affair – Wishes, Ken Stead (Cancelled)",
  "2018 - 2019": "Gateway Chorus, Over The Moon, The Wardens",
  "2014 - 2015": "MCT – Hansel + Gretel, Will Stroet and the Backyard Band",
  "2013 - 2014": "Fred Penner, Wizard of Oz",
  "2012 - 2013": "Splash\"N\"Boots, Missoula Children's Theatre – Jack and the Beanstalk",
  "2011 - 2012": "Fables – Sun Ergos, Missoula Children's Theatre – The Pied Piper",
  "2010 - 2011": "Figura, Missoula Children's Theatre – King Arthur's Quest",
  "2009 - 2010": "Max-I-Mime, Missoula Children's Theatre – Snow White and The Seven Dwarfs",
  "2008 - 2009": "Missoula Children's Theatre – Robin Hood, Cheremosh",
  "2007 - 2008": "Val Hilliker, Youth singers of Calgary"
};

// Family Concerts by season (for seasons that don't have Winter Matinee)
const familyConcerts = {
  "2013 - 2014": "Fred Penner, Wizard of Oz",
  "2012 - 2013": "Splash\"N\"Boots, Missoula Children's Theatre – Jack and the Beanstalk",
  "2011 - 2012": "Fables – Sun Ergos, Missoula Children's Theatre – The Pied Piper",
  "2010 - 2011": "Figura, Missoula Children's Theatre – King Arthur's Quest",
  "2009 - 2010": "Max-I-Mime, Missoula Children's Theatre – Snow White and The Seven Dwarfs",
  "2008 - 2009": "Missoula Children's Theatre – Robin Hood, Cheremosh",
  "2007 - 2008": "Val Hilliker, Youth singers of Calgary"
};

// Combine automatically generated seasons with manually defined ones
const allSeasons = new Set([...seasons, ...Object.keys(manuallyDefinedSeasons)]);
const sortedSeasons = Array.from(allSeasons).sort().reverse();

---

<Layout title="Past events" description="Browse past events at Daysland Palace Theatre. Explore the highlights and history of performances, films, and community gatherings in Daysland, Alberta.">
  <!-- HeroSecondary text structure
    title case
    sentence case
    sentence case
  -->
  <HeroSecondary
    tagline="Relive the Magic"
    title="Past shows"
    content="Explore the highlights of shows">
    <FireIcon slot="icon" class="h-10" />
  </HeroSecondary>

  <Main>
  <div class="lg:grid lg:grid-cols-12 lg:gap-8">
    <div class="lg:col-span-5">
      <h2 class="text-2xl font-bold leading-10 tracking-tight text-gray-900">Previous events</h2>
      <p class="mt-4 text-base leading-7 text-gray-600">Look through our <a href="https://www.facebook.com/profile.php?id=100063455833057&sk=photos_albums" target="_blank" class="font-semibold text-purple-600 hover:text-purple-500">Facebook albums</a> to see past shows.</p>
    </div>

    <div class="mt-10 lg:col-span-7 lg:mt-0">
      <dl class="space-y-10">
        {sortedSeasons.map((season) => (
          <div>
            <dt class="text-lg font-bold leading-7 text-gray-900">{season}</dt>
            <dd class="mt-2 text-base leading-7 text-gray-600">
              {/* Show dynamically loaded events if available */}
              {eventsBySeasons[season] && eventsBySeasons[season].length > 0 ? (
                eventsBySeasons[season].map((event, index) => (
                  <span>
                    {event.frontmatter.title}{index < eventsBySeasons[season].length - 1 ? ', ' : ''}
                  </span>
                ))
              ) : (
                /* Fall back to manually defined events */
                manuallyDefinedSeasons[season] && manuallyDefinedSeasons[season]
              )}
              
              {/* Add Winter Matinee Concert Series if available for this season */}
              {winterMatineeSeries[season] && (
                <div class="indent-8">
                  <p class="mt-8 text-base font-semibold leading-7 text-gray-900">Winter Matinee Concert Series</p>
                  <p class="mt-2 text-base leading-7 text-gray-600">{winterMatineeSeries[season]}</p>
                </div>
              )}
              
              {/* Add Family Concerts if available for this season */}
              {!winterMatineeSeries[season] && familyConcerts[season] && (
                <div class="indent-8">
                  <p class="mt-8 text-base font-semibold leading-7 text-gray-900">Family Concerts</p>
                  <p class="mt-2 text-base leading-7 text-gray-600">{familyConcerts[season]}</p>
                </div>
              )}
            </dd>
          </div>
        ))}
      </dl>
    </div>
  </div>
  </Main>
</Layout>