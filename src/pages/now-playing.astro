---
import Layout from "../layouts/Layout.astro";
import Main from "@components/html-structure/Main.astro";
import MovieList from "@components/movie/MovieList.astro";
import HeroSecondary from "@components/hero-secondary.astro";
import TheatreClosed from "@/components/theatre-closed.astro";
import { VideoCameraIcon } from '@heroicons/vue/24/outline';
import { getMovies } from "@/utils/appwrite";
import type { Movie } from "@/utils/appwrite";

// Fetch movies from Appwrite
const movies = await getMovies();

// Function to normalize dates to start of day for comparison
function normalizeDate(date: Date): Date {
  return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}

// Filter movies to only show those with future showtimes
const activeMovies = movies.filter(movie => {
  const today = normalizeDate(new Date());
  return movie.showTimes?.some((showtime: string) => 
    normalizeDate(new Date(showtime)) >= today
  ) ?? false;
});

let hasMovies = activeMovies && activeMovies.length > 0;

---

<Layout title="Now playing at Daysland Theatre">
  <!-- HeroSecondary text structure
    title case
    sentence case
    sentence case
  -->
  <HeroSecondary
    tagline="Experience Adventure"
    title="Now playing"
    content="Dive into our latest cinematic adventure">
    <VideoCameraIcon slot="icon" class="h-10" />
  </HeroSecondary>

  <Main>
    {hasMovies ? (
      <MovieList movieEntries={activeMovies} />
    ) : (
      <TheatreClosed />
    )}
  </Main>
</Layout>